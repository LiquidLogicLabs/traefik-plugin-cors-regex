name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Verify dependencies
        run: |
          go mod verify
          go mod tidy
          # Only check go.mod since go.sum may not exist for stdlib-only dependencies
          git diff --exit-code go.mod || true

      - name: Run tests
        run: |
          go test -v ./...

      - name: Vendor dependencies
        run: |
          go mod vendor
          
      - name: Create vendor archive
        run: |
          tar -czf vendor.tar.gz vendor/

      - name: Build plugin
        run: |
          CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o traefik-plugin-cors-regex .

      - name: Get version
        id: version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "VERSION_NUMBER=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update VERSION file
        run: |
          echo "${{ steps.version.outputs.VERSION_NUMBER }}" > VERSION

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## Changes
          
          See [CHANGELOG.md](https://github.com/liquidlogiclabs/traefik-plugin-cors-regex/blob/main/CHANGELOG.md) for detailed changes.
          
          ## Installation
          
          Add to your Traefik configuration:
          
          ```yaml
          experimental:
            plugins:
              cors-regex:
                modulename: github.com/liquidlogiclabs/traefik-plugin-cors-regex
                version: ${{ steps.version.outputs.VERSION }}
          ```
          
          ## Usage
          
          ```yaml
          http:
            middlewares:
              cors-regex:
                plugin:
                  cors-regex:
                    allowOriginList:
                      - "https://example.com"
                      - "https://*.example.com"
                    allowMethods:
                      - "GET"
                      - "POST"
                      - "OPTIONS"
                    allowCredentials: true
          ```
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          files: |
            traefik-plugin-cors-regex
            vendor.tar.gz
            VERSION
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Submit to Traefik Plugin Catalog
        run: |
          echo "ðŸŽ‰ Release ${{ steps.version.outputs.VERSION }} created!"
          echo "ðŸ“ To submit to Traefik Plugin Catalog:"
          echo "   1. Ensure repository is not a fork"
          echo "   2. Add 'traefik-plugin' topic to repository"
          echo "   3. Repository will be automatically discovered by Traefik"
          echo "   4. Monitor https://plugins.traefik.io/ for inclusion"
