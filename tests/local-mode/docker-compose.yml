services:
  # Test application backend
  test-app:
    image: nginx:alpine
    container_name: test-app
    ports:
      - "8991:80"
    volumes:
      - ../../config/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.test-app.rule=Host(`localhost`) && PathPrefix(`/test`)"
      - "traefik.http.routers.test-app.entrypoints=web"
      - "traefik.http.services.test-app.loadbalancer.server.port=80"
      # Attach CORS middleware
      - "traefik.http.routers.test-app.middlewares=cors-regex"

  # Traefik in local plugin mode
  traefik:
    image: traefik:v3.0
    container_name: traefik-with-cors-plugin
    depends_on:
      - test-app
    ports:
      - "8989:80"     # web
      - "8990:9000"   # dashboard
    networks:
      - traefik-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Mount plugin source at local mode path (project root)
      - ../../:/plugins-local/src/github.com/liquidlogiclabs/traefik-plugin-cors-regex:ro
      # Static and dynamic config
      - ../../config/traefik.yml:/etc/traefik/traefik.yml:ro
      - ../../config/dynamic.yml:/etc/traefik/conf/dynamic.yml:ro
    command:
      - "--api.insecure=true"
      - "--entryPoints.web.address=:80"
      - "--entryPoints.dashboard.address=:9000"
      - "--providers.file.directory=/etc/traefik/conf"
      - "--providers.file.watch=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      # Local plugin wiring (also present in traefik.yml for clarity)
      - "--experimental.localPlugins.cors-regex.moduleName=github.com/liquidlogiclabs/traefik-plugin-cors-regex"
    labels:
      - "traefik.enable=true"
      # Dashboard router
      - "traefik.http.routers.traefik.rule=Host(`localhost`) && PathPrefix(`/api`)"
      - "traefik.http.routers.traefik.service=api@internal"
      # CORS middleware configuration
      - "traefik.http.middlewares.cors-regex.plugin.cors-regex.alloworiginlist=https://example.com,https://*.example.com,https://api.example.org"
      - "traefik.http.middlewares.cors-regex.plugin.cors-regex.allowmethods=GET,POST,PUT,DELETE,OPTIONS"
      - "traefik.http.middlewares.cors-regex.plugin.cors-regex.allowheaders=Origin,Content-Type,Accept,Authorization"
      - "traefik.http.middlewares.cors-regex.plugin.cors-regex.allowcredentials=true"
      - "traefik.http.middlewares.cors-regex.plugin.cors-regex.maxage=86400"
      - "traefik.http.middlewares.cors-regex.plugin.cors-regex.debug=true"

  # Optional: one-shot tester container to run tests inside the network
  tester:
    image: alpine:3.20
    container_name: cors-plugin-tester
    depends_on:
      - traefik
    networks:
      - traefik-network
    entrypoint: ["/bin/sh","-c"]
    command: ["apk add --no-cache curl jq >/dev/null; sh /tests/test.sh"]
    volumes:
      - .:/tests:ro

networks:
  traefik-network:
    driver: bridge
